<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="smile">
<title>2. Fitting models and making predictions • smile</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><link href="../deps/_Roboto-0.4.1/font.css" rel="stylesheet">
<link href="../deps/_JetBrains%20Mono-0.4.1/font.css" rel="stylesheet">
<link href="../deps/_Roboto%20Slab-0.4.1/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="2. Fitting models and making predictions">
<meta property="og:description" content="smile">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">smile</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.3</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown--vignettes">
    <span class="fa fa-book fa-lg"></span>
     
    Vignettes
  </a>
  <div class="dropdown-menu" aria-labelledby="dropdown--vignettes">
    <a class="dropdown-item" href="../articles/sf-to-spm.html">1. Converting sf objects to spm</a>
    <a class="dropdown-item" href="../articles/fit-and-pred.html">2. Fitting models and making predictions</a>
    <a class="dropdown-item" href="../articles/sai.html">3. Simple Areal Interpolation</a>
    <a class="dropdown-item" href="../articles/theory.html">4. Method</a>
    <a class="dropdown-item" href="../articles/sp-cov-functions.html">5. Spatial covariance functions</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">
    <span class="fa fa-search fa-lg"></span>
     
    Reference
  </a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/lcgodoy">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://stacksoverflow.com/users/9220758/lcgodoy">
    <span class="fa fa-stack-overflow fa-lg"></span>
     
  </a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://twitter.com/ldcgodoy">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://www.linkedin.com/in/godoy-lucas/">
    <span class="fa fa-linkedin"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="fit-and-pred_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>2. Fitting models and making predictions</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/lcgodoy/smile/blob/HEAD/vignettes/fit-and-pred.Rmd" class="external-link"><code>vignettes/fit-and-pred.Rmd</code></a></small>
      <div class="d-none name"><code>fit-and-pred.Rmd</code></div>
    </div>

    
    
<hr>
<p>If interested in the theory involving this calculations, take a look at <a href="https://lcgodoy.me/smile/articles/theory.html">this vignette</a>.</p>
<hr>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lcgodoy.me/smile/">smile</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span>
<span class="co">#&gt; Linking to GEOS 3.8.0, GDAL 3.0.4, PROJ 6.3.1; sf_use_s2() is TRUE</span></code></pre></div>
<p>Considering the same setup used in the vignette about converting <code>sf</code> to <code>spm</code> <a href="https://lcgodoy.me/smile/articles/sf-to-spm.html">objects</a>, we are going to predict the Life Expecation at Birth (LEF) score (observed at the Middle Super Output Areas (MSOA), in Liverpool, into the Lower Super Output Area (LSOA). In this second level, we have the Life Expectancy at Birth for each area. This data was taken from <span class="citation">Johnson, Diggle, and Giorgi (2020)</span>.</p>
<p>The code below loads the data and converts the LSOA <code>sf</code> object into a <code>spm</code> object. In particular, we are going to use numerical integration (based on a 500 points grid) with the precision of the integrals varying according to the size of each MSOA region. The name of the variable we are interested in, in the <code>liv_msoa</code>, is <code>"leb_est"</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">liv_msoa</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">liv_lsoa</span><span class="op">)</span>

<span class="co">## workaround for compatibility with different PROJ versions</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">liv_msoa</span><span class="op">)</span> <span class="op">&lt;-</span>
    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">liv_msoa</span><span class="op">)</span><span class="op">$</span><span class="va">input</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">liv_lsoa</span><span class="op">)</span> <span class="op">&lt;-</span>
    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">liv_lsoa</span><span class="op">)</span><span class="op">$</span><span class="va">input</span>

<span class="co">## msoa from sf to spm</span>
<span class="va">spm_msoa</span> <span class="op">&lt;-</span>
    <span class="fu"><a href="../reference/sf_to_spm.html">sf_to_spm</a></span><span class="op">(</span>sf_obj <span class="op">=</span> <span class="va">liv_msoa</span>,
              n_pts  <span class="op">=</span> <span class="fl">500</span>,
              type   <span class="op">=</span> <span class="st">"regular"</span>,
              by_polygon <span class="op">=</span> <span class="cn">FALSE</span>,
              poly_ids <span class="op">=</span> <span class="st">"msoa11cd"</span>,
              var_ids  <span class="op">=</span> <span class="st">"leb_est"</span><span class="op">)</span></code></pre></div>
<p>Next, we assume the following model, at the grid level, drives the data<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;To check how the model at the grid level relates to the data at the area level check the &lt;a href="https://lcgodoy.me/smile/articles/theory.html"&gt;Theory vignette&lt;/a&gt;&lt;/p&gt;'><sup>1</sup></a> <span class="math display">\[
    Y(\mathbf{s}) = \mu + S(\mathbf{s}) + \varepsilon(\mathbf{s}), 
\]</span> where <span class="math inline">\(S(\cdot) \sim {\rm GP}(0, {\rm C}(\cdot ; \, \boldsymbol{\theta}))\)</span>, and <span class="math inline">\(\varepsilon(\cdot) \overset{{\rm i.i.d.}}{\sim} {\rm N}(0, \tau)\)</span>, with <span class="math inline">\(S(\cdot) \perp \varepsilon(\cdot)\)</span>. The form of the covariance functions considered here are written as follows <span class="math inline">\({\rm C}(\cdot ; \, \boldsymbol{\theta} ) = \sigma^2 \rho(\cdot ; \, \boldsymbol{\theta})\)</span>. Where <span class="math inline">\(\rho(\cdot ; \, \boldsymbol{\theta})\)</span> is a stationary and isotropic correlation function. To check the families of correlation functions available in our package, check <a href="https://lcgodoy.me/smile/articles/sp-cov-functions.html">this link</a>. Another important detail is that, if we make <span class="math inline">\(\nu = \tau / \sigma^2\)</span>, the estimation process is slightly easier. The package allows for the two parametrizations.</p>
<p>For this problem we are going to consider the the Matérn covariance function. The model will be fitted with <span class="math inline">\(\kappa = .5, 1.5, 2.5\)</span>, this the parameter controls the smoothness of the spatial process. Also, for simplicity, we are going to ignore <span class="math inline">\(\tau\)</span>. Next, we evaluate the AIC associated with three models. The function <code>fit_spm</code> fits the models and needs starting values for <span class="math inline">\(\phi\)</span> (and <span class="math inline">\(\nu\)</span> or <span class="math inline">\(\tau\)</span>, if you decide not to ignore the small scale variation), the covariance model to be used is informed as a string in the argument <code>model</code>, the available options are <code>c("matern", "pexp", "gaussian", "spherical")</code>. Notice that, when not inputting an initial value for <span class="math inline">\(\nu\)</span> (or <span class="math inline">\(\tau\)</span>), we are forcing this parameter to be 0. Also, the <code>theta_st</code> argument (which takes the initial values for the parameters), must be a named vector. If we input initial values for <span class="math inline">\(\mu\)</span>, <span class="math inline">\(\sigma^2\)</span>, <span class="math inline">\(\phi\)</span>, and <span class="math inline">\(\nu\)</span> (or <span class="math inline">\(\tau\)</span>), the likelihood is optimized numerically for all the parameters. If we omit <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\sigma^2\)</span>, then a profile likelihood approach is used to find numerically for the <span class="math inline">\(\hat{\phi}\)</span> and, if wished, <span class="math inline">\(\hat{\nu}\)</span>. While, <span class="math inline">\(\hat{\mu}\)</span> and <span class="math inline">\(\hat{\sigma}^2\)</span> have closed form expressions <span class="citation">(Diggle and Ribeiro 2007)</span>. Additionally, the commented part of the code below shows how to proceed to estimate <span class="math inline">\(\nu\)</span>, an equivalently <span class="math inline">\(\tau\)</span>, from the data. The argument <code>apply_exp</code> is a workaround for parameters that cannot be negative. The arguments <code>opt_method</code> and <code>control</code> are passed to the function <code>optim</code> in order to optimize the log likelihood associated with the data. <code>opt_method</code> controls the optimization algorithm to be used, while <code>control</code> inputs control arguments for such optimization algorithms, for more details see <a href="https://stat.ethz.ch/R-manual/R-devel/library/stats/html/optim.html" class="external-link">optim</a>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">theta_st_msoa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"phi"</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>

<span class="co">## 1) it is important to NAME the initial values for each parameter</span>
<span class="co">## 2) to estimate "nu" from the data we only need to provide an initial value for such</span>
<span class="co">## parameter</span>
<span class="co">## 3) uncomment the code below to do so.</span>
<span class="co">## 4) Note that it is possible to set the boundaries for the parameter space on</span>
<span class="co">## which we want to optmize the likelihood.</span>
<span class="co">## theta_st_msoa &lt;- c("phi" = 1, "nu" = 1)</span>
<span class="co">## fit_msoa1 &lt;-</span>
<span class="co">##     fit_spm(x = spm_msoa,</span>
<span class="co">##             theta_st = theta_st_msoa,</span>
<span class="co">##             model = "matern",</span>
<span class="co">##             kappa = .5,</span>
<span class="co">##             lower = c(1e-16, 1e-16),</span>
<span class="co">##             upper = c(Inf, 1),</span>
<span class="co">##             opt_method = "L-BFGS-B",</span>
<span class="co">##             control   = list(maxit = 500))</span>

<span class="va">fit_msoa1</span> <span class="op">&lt;-</span>
    <span class="fu"><a href="../reference/fit_spm.html">fit_spm</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">spm_msoa</span>,
            theta_st <span class="op">=</span> <span class="va">theta_st_msoa</span>,
            model <span class="op">=</span> <span class="st">"matern"</span>,
            kappa <span class="op">=</span> <span class="fl">.5</span>,
            apply_exp <span class="op">=</span> <span class="cn">TRUE</span>,
            opt_method <span class="op">=</span> <span class="st">"L-BFGS-B"</span>,
            control   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>maxit <span class="op">=</span> <span class="fl">500</span><span class="op">)</span><span class="op">)</span>

<span class="va">fit_msoa2</span> <span class="op">&lt;-</span>
    <span class="fu"><a href="../reference/fit_spm.html">fit_spm</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">spm_msoa</span>,
            theta_st <span class="op">=</span> <span class="va">theta_st_msoa</span>,
            model <span class="op">=</span> <span class="st">"gaussian"</span>,
            kappa <span class="op">=</span> <span class="fl">1.5</span>,
            apply_exp <span class="op">=</span> <span class="cn">TRUE</span>,
            opt_method <span class="op">=</span> <span class="st">"L-BFGS-B"</span>,
            control   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>maxit <span class="op">=</span> <span class="fl">500</span><span class="op">)</span><span class="op">)</span>

<span class="va">fit_msoa3</span> <span class="op">&lt;-</span>
    <span class="fu"><a href="../reference/fit_spm.html">fit_spm</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">spm_msoa</span>,
            theta_st <span class="op">=</span> <span class="va">theta_st_msoa</span>,
            model <span class="op">=</span> <span class="st">"matern"</span>,
            kappa <span class="op">=</span> <span class="fl">2.5</span>,
            apply_exp <span class="op">=</span> <span class="cn">TRUE</span>,
            opt_method <span class="op">=</span> <span class="st">"L-BFGS-B"</span>,
            control   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>maxit <span class="op">=</span> <span class="fl">500</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The AIC<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;BIC works for our models too.&lt;/p&gt;"><sup>2</sup></a> associated with each model is given below. According to this criterion, the best model is the one with <span class="math inline">\(\kappa = .5\)</span>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"m1"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/AIC.html" class="external-link">AIC</a></span><span class="op">(</span><span class="va">fit_msoa1</span><span class="op">)</span>, <span class="st">"m2"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/AIC.html" class="external-link">AIC</a></span><span class="op">(</span><span class="va">fit_msoa2</span><span class="op">)</span>, <span class="st">"m3"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/AIC.html" class="external-link">AIC</a></span><span class="op">(</span><span class="va">fit_msoa3</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;       m1       m2       m3 </span>
<span class="co">#&gt; 296.8581 297.7891 297.1204</span></code></pre></div>
<p>We can retrieve the estimated parameters and the associated <code>(1 - sig)</code> % confidence intervals by using the function <code>summary_spm_fit</code> as follows</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/summary_spm_fit.html">summary_spm_fit</a></span><span class="op">(</span><span class="va">fit_msoa1</span>, sig <span class="op">=</span> <span class="fl">.05</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  optimization algorithm converged: yes </span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     par   estimate        se               ci</span>
<span class="co">#&gt; 1    mu 75.9197812 0.7669466 [74.417; 77.423]</span>
<span class="co">#&gt; 2 sigsq 23.2583085 4.2420591 [14.944; 31.573]</span>
<span class="co">#&gt; 3   phi  0.7737321 0.1995936   [0.383; 1.165]</span></code></pre></div>
<p>Finally, we have almost everything we need to perform predictions at the LSOA areas. The function <code>predict_spm</code> calculates the predictions associated to the <code>spm_obj</code> (which contains the results associated with a fitted model) into a <code>sf</code> object given as an input for the argument <code>x</code>. We need to specify whether we want to “aggregate” (i.e. average) the predicted surface over the polygons associated with the <code>sf</code> data. The number of points and the type of integration for prediction need to be set as well. In this case we are specifying a finer grid (3500 points) because the LSOA areas are smaller than the MSOA areas.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pred_lsoa</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predict_spm.html">predict_spm</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">liv_lsoa</span>, spm_obj <span class="op">=</span> <span class="va">fit_msoa1</span>, id_var <span class="op">=</span> <span class="st">"lsoa11cd"</span><span class="op">)</span>
<span class="co">#&gt; Warning in st_centroid.sf(x = x[empty_polys, id_var]): st_centroid assumes</span>
<span class="co">#&gt; attributes are constant over geometries of x</span></code></pre></div>
<p>The resulting object is a list with entries <code>"mu_pred"</code>, <code>"sig_pred"</code>, <code>"pred_grid"</code>, <code>"pred_agg"</code>. The first two positions correspond to the mean and covariance matrix at the predicted locations, respectively. <code>"pred_grid"</code> can be seen as the predicted surface over the study region, while <code>"pred_agg"</code> contains the (integrals) averages of such surface within each LSOA area. The chunk of code below plots the predicted life expectancy at the LSOA areas.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">pred_lsoa</span><span class="op">$</span><span class="va">pred_agg</span>,
       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill  <span class="op">=</span> <span class="va">mu_pred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fl">1</span>,
            lwd <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"H"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text  <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
          axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="fit-and-pred_files/figure-html/manip-pred-1-1.png" width="700"></p>
<p>Next, we plot the standard errors associated with the predictions.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">pred_lsoa</span><span class="op">$</span><span class="va">pred_agg</span>,
       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill  <span class="op">=</span> <span class="va">se_pred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fl">1</span>,
            lwd <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"H"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text  <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
          axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="fit-and-pred_files/figure-html/se-ggplot2-1.png" width="700"></p>
<div class="section level2">
<h2 id="reference">Reference<a class="anchor" aria-label="anchor" href="#reference"></a>
</h2>
<div id="refs" class="references">
<div id="ref-diggle2007model">
<p>Diggle, PJ, and Paulo Justiniano Ribeiro. 2007. “Model-Based Geostatistics (Springer Series in Statistics).” In, 51–56. Springer.</p>
</div>
<div id="ref-johnson2020dealing">
<p>Johnson, Olatunji, Peter Diggle, and Emanuele Giorgi. 2020. “Dealing with Spatial Misalignment to Model the Relationship Between Deprivation and Life Expectancy: A Model-Based Geostatistical Approach.” <em>International Journal of Health Geographics</em> 19 (1): 1–13.</p>
</div>
</div>
</div>

  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Powered by <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Lucas da Cunha Godoy. Provided without <strong>any warranty</strong>.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
