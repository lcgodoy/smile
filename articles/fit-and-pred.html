<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>2. Fitting models and making predictions • smile</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Roboto-0.4.9/font.css" rel="stylesheet">
<link href="../deps/JetBrains_Mono-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Roboto_Slab-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="2. Fitting models and making predictions">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">smile</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.6</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fa-home"></span> HOME</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa fa-book"></span> Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes">
<li><a class="dropdown-item" href="../articles/sf-to-spm.html">1. Converting sf objects to spm</a></li>
    <li><a class="dropdown-item" href="../articles/fit-and-pred.html">2. Fitting models and making predictions</a></li>
    <li><a class="dropdown-item" href="../articles/sai.html">3. Areal Interpolation</a></li>
    <li><a class="dropdown-item" href="../articles/theory.html">4. Method</a></li>
    <li><a class="dropdown-item" href="../articles/sp-cov-functions.html">5. Spatial covariance functions</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html"><span class="fa fa-search fa-lg"></span> Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://lcgodoy.me" aria-label="Personal website"><span class="fa fa-globe"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/lcgodoy" aria-label="GitHub Profile"><span class="fa fa-github"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://www.linkedin.com/in/godoy-lucas/" aria-label="Linkedin Profile"><span class="fa fa-linkedin"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>2. Fitting models and making predictions</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/lcgodoy/smile/blob/main/vignettes/fit-and-pred.Rmd" class="external-link"><code>vignettes/fit-and-pred.Rmd</code></a></small>
      <div class="d-none name"><code>fit-and-pred.Rmd</code></div>
    </div>

    
    
<hr>
<p>If interested in the theory involving this calculations, take a look
at <a href="https://lcgodoy.me/smile/articles/theory.html">this
vignette</a>.</p>
<blockquote>
<p>These functions will work only for planar projections. If working
with a spherical projection, we recommend using a <em>powered
exponential</em> covariance function with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>κ</mi><mo>∈</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\kappa \in (0, 1)</annotation></semantics></math>.</p>
</blockquote>
<hr>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lcgodoy.me/smile/">smile</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Linking to GEOS 3.10.2, GDAL 3.4.1, PROJ 8.2.1; sf_use_s2() is TRUE</span></span></code></pre></div>
<p>Considering the same setup used in the vignette about converting
<code>sf</code> to <code>spm</code> <a href="https://lcgodoy.me/smile/articles/sf-to-spm.html">objects</a>, we
are going to predict the Life Expectation at Birth (LEF) score (observed
at the Middle Super Output Areas (MSOA), in Liverpool, into the Lower
Super Output Area (LSOA). In this second level, we have the Life
Expectancy at Birth for each area. This data is available in the package
and was made available by <span class="citation">Johnson, Diggle, and
Giorgi (2020)</span>.</p>
<p>The code below loads the data and converts the LSOA <code>sf</code>
object into a <code>spm</code> object. We are going to use numerical
integration (based on a 500 points grid) with the precision of the
integrals varying according to the size of each MSOA region. We are
interested in a variable called <code>"leb_est"</code> available only at
the <code>liv_msoa</code> dataset.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">liv_msoa</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">liv_lsoa</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## workaround for compatibility with different PROJ versions</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">liv_msoa</span><span class="op">)</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">liv_msoa</span><span class="op">)</span><span class="op">$</span><span class="va">input</span></span>
<span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">liv_lsoa</span><span class="op">)</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">liv_lsoa</span><span class="op">)</span><span class="op">$</span><span class="va">input</span></span>
<span></span>
<span><span class="co">## msoa from sf to spm</span></span>
<span><span class="va">spm_msoa</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="../reference/sf_to_spm.html">sf_to_spm</a></span><span class="op">(</span>sf_obj <span class="op">=</span> <span class="va">liv_msoa</span>,</span>
<span>              n_pts  <span class="op">=</span> <span class="fl">500</span>,</span>
<span>              type   <span class="op">=</span> <span class="st">"regular"</span>,</span>
<span>              by_polygon <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>              poly_ids <span class="op">=</span> <span class="st">"msoa11cd"</span>,</span>
<span>              var_ids  <span class="op">=</span> <span class="st">"leb_est"</span><span class="op">)</span></span></code></pre></div>
<p>Next, we assume the following model, at the grid level, drives the
data<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;To check how the model at the grid level relates to the
data at the area level check the &lt;a href="https://lcgodoy.me/smile/articles/theory.html"&gt;Theory
vignette&lt;/a&gt;&lt;/p&gt;'><sup>1</sup></a></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐬</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>μ</mi><mo>+</mo><mi>S</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐬</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mi>ε</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐬</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo></mrow><annotation encoding="application/x-tex">Y(\mathbf{s}) = \mu + S(\mathbf{s}) + \varepsilon(\mathbf{s}), </annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mrow><mo stretchy="true" form="prefix">(</mo><mo>⋅</mo><mo stretchy="true" form="postfix">)</mo></mrow><mo>∼</mo><mrow><mi mathvariant="normal">G</mi><mi mathvariant="normal">P</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mi mathvariant="normal">C</mi><mrow><mo stretchy="true" form="prefix">(</mo><mo>⋅</mo><mo>;</mo><mspace width="0.167em"></mspace><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">S(\cdot) \sim \mathrm{GP}(0, \mathrm{C}(\cdot ; \,
\boldsymbol{\theta}))</annotation></semantics></math>, and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ε</mi><mrow><mo stretchy="true" form="prefix">(</mo><mo>⋅</mo><mo stretchy="true" form="postfix">)</mo></mrow><mover><mo>∼</mo><mrow><mi mathvariant="normal">i</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">d</mi><mi mathvariant="normal">.</mi></mrow></mover><mi mathvariant="normal">N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mi>τ</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\varepsilon(\cdot) \overset{\mathrm{i.i.d.}}{\sim}
\mathrm{N}(0, \tau)</annotation></semantics></math>, with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mrow><mo stretchy="true" form="prefix">(</mo><mo>⋅</mo><mo stretchy="true" form="postfix">)</mo></mrow><mo>⊥</mo><mi>ε</mi><mrow><mo stretchy="true" form="prefix">(</mo><mo>⋅</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">S(\cdot) \perp \varepsilon(\cdot)</annotation></semantics></math>.
The form of the covariance functions considered here are written as
follows
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">C</mi><mrow><mo stretchy="true" form="prefix">(</mo><mo>⋅</mo><mo>;</mo><mspace width="0.167em"></mspace><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msup><mi>σ</mi><mn>2</mn></msup><mi>ρ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mo>⋅</mo><mo>;</mo><mspace width="0.167em"></mspace><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathrm{C}(\cdot ;
\, \boldsymbol{\theta} ) = \sigma^2 \rho(\cdot ; \, \boldsymbol{\theta})</annotation></semantics></math>.
Where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ρ</mi><mrow><mo stretchy="true" form="prefix">(</mo><mo>⋅</mo><mo>;</mo><mspace width="0.167em"></mspace><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\rho(\cdot ; \, \boldsymbol{\theta})</annotation></semantics></math>
is a stationary and isotropic correlation function. To check the
families of correlation functions available in our package, check <a href="https://lcgodoy.me/smile/articles/sp-cov-functions.html">this
link</a>. Another important detail is that, if we make
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mo>=</mo><mi>τ</mi><mi>/</mi><msup><mi>σ</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\alpha = \tau / \sigma^2</annotation></semantics></math>,
the estimation process is slightly easier. The package allows for the
two parametrizations.</p>
<p>For this problem we are going to consider the the Matérn covariance
function. The model will be fitted with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ν</mi><mo>∈</mo><mo stretchy="false" form="prefix">{</mo><mn>0.5</mn><mo>,</mo><mn>1.5</mn><mo>,</mo><mn>2.5</mn><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">\nu \in \{0.5, 1.5, 2.5\}</annotation></semantics></math>,
this the parameter controls the smoothness of the spatial process. Also,
for simplicity, we are going to ignore
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>.
Next, we evaluate the AIC associated with three models. The function
<code>fit_spm</code> fits the models and needs starting values for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ϕ</mi><annotation encoding="application/x-tex">\phi</annotation></semantics></math>
(and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
or
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>,
if you decide not to ignore the small scale variation), the covariance
model to be used is informed as a string in the argument
<code>model</code>, the available options are
<code>c("matern", "pexp", "gaussian", "spherical")</code>. Notice that,
when not inputting an initial value for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
(or
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>),
we are forcing this parameter to be 0. Also, the <code>theta_st</code>
argument (which takes the initial values for the parameters), must be a
named vector. If we input initial values for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>μ</mi><annotation encoding="application/x-tex">\mu</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>σ</mi><mn>2</mn></msup><annotation encoding="application/x-tex">\sigma^2</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ϕ</mi><annotation encoding="application/x-tex">\phi</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
(or
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>),
the likelihood is optimized numerically for all the parameters. If we
omit
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>μ</mi><annotation encoding="application/x-tex">\mu</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>σ</mi><mn>2</mn></msup><annotation encoding="application/x-tex">\sigma^2</annotation></semantics></math>,
then a profile likelihood approach is used to find numerically
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>ϕ</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{\phi}</annotation></semantics></math>
and, if wished,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>α</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{\alpha}</annotation></semantics></math>.
While,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>μ</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{\mu}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mover><mi>σ</mi><mo accent="true">̂</mo></mover><mn>2</mn></msup><annotation encoding="application/x-tex">\hat{\sigma}^2</annotation></semantics></math>
have closed form expressions <span class="citation">(Diggle and Ribeiro
2007)</span>. Additionally, the commented part of the code below shows
how to proceed to estimate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
(or
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>)
from the data. The argument <code>apply_exp</code> is a workaround for
parameters that cannot be negative. The arguments
<code>opt_method</code> and <code>control</code> are passed to the
function <code>optim</code>. <code>opt_method</code> controls the
optimization algorithm to be used, while <code>control</code> inputs
control arguments for such optimization algorithms, for more details see
<a href="https://stat.ethz.ch/R-manual/R-devel/library/stats/html/optim.html" class="external-link">optim</a>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">theta_st_msoa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"phi"</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 1) it is important to NAME the initial values for each parameter</span></span>
<span><span class="co">## 2) to estimate "nu" from the data we only need to provide an initial value for such</span></span>
<span><span class="co">## parameter</span></span>
<span><span class="co">## 3) uncomment the code below to do so.</span></span>
<span><span class="co">## 4) Note that it is possible to set the boundaries for the parameter space on</span></span>
<span><span class="co">## which we want to optmize the likelihood.</span></span>
<span><span class="co">## theta_st_msoa &lt;- c("phi" = 1, "nu" = 1)</span></span>
<span><span class="co">## fit_msoa1 &lt;-</span></span>
<span><span class="co">##     fit_spm(x = spm_msoa,</span></span>
<span><span class="co">##             theta_st = theta_st_msoa,</span></span>
<span><span class="co">##             model = "matern",</span></span>
<span><span class="co">##             nu = .5,</span></span>
<span><span class="co">##             lower = c(1e-16, 1e-16),</span></span>
<span><span class="co">##             upper = c(Inf, 1),</span></span>
<span><span class="co">##             opt_method = "L-BFGS-B",</span></span>
<span><span class="co">##             control   = list(maxit = 500))</span></span>
<span></span>
<span><span class="va">fit_msoa1</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="../reference/fit_spm.html">fit_spm</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">spm_msoa</span>,</span>
<span>            theta_st <span class="op">=</span> <span class="va">theta_st_msoa</span>,</span>
<span>            model <span class="op">=</span> <span class="st">"matern"</span>,</span>
<span>            nu <span class="op">=</span> <span class="fl">.5</span>,</span>
<span>            apply_exp <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>            opt_method <span class="op">=</span> <span class="st">"L-BFGS-B"</span>,</span>
<span>            control   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>maxit <span class="op">=</span> <span class="fl">500</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit_msoa2</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="../reference/fit_spm.html">fit_spm</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">spm_msoa</span>,</span>
<span>            theta_st <span class="op">=</span> <span class="va">theta_st_msoa</span>,</span>
<span>            model <span class="op">=</span> <span class="st">"matern"</span>,</span>
<span>            nu <span class="op">=</span> <span class="fl">1.5</span>,</span>
<span>            apply_exp <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>            opt_method <span class="op">=</span> <span class="st">"L-BFGS-B"</span>,</span>
<span>            control    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>maxit <span class="op">=</span> <span class="fl">500</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit_msoa3</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="../reference/fit_spm.html">fit_spm</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">spm_msoa</span>,</span>
<span>            theta_st <span class="op">=</span> <span class="va">theta_st_msoa</span>,</span>
<span>            model <span class="op">=</span> <span class="st">"matern"</span>,</span>
<span>            nu <span class="op">=</span> <span class="fl">2.5</span>,</span>
<span>            apply_exp <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>            opt_method <span class="op">=</span> <span class="st">"L-BFGS-B"</span>,</span>
<span>            control   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>maxit <span class="op">=</span> <span class="fl">500</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The AIC<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;BIC works for our models too.&lt;/p&gt;"><sup>2</sup></a> associated with each model is given below.
According to this criterion, the best model is the one with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ν</mi><mo>=</mo><mn>.5</mn></mrow><annotation encoding="application/x-tex">\nu =
.5</annotation></semantics></math>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"m1"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/AIC.html" class="external-link">AIC</a></span><span class="op">(</span><span class="va">fit_msoa1</span><span class="op">)</span>, <span class="st">"m2"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/AIC.html" class="external-link">AIC</a></span><span class="op">(</span><span class="va">fit_msoa2</span><span class="op">)</span>, <span class="st">"m3"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/AIC.html" class="external-link">AIC</a></span><span class="op">(</span><span class="va">fit_msoa3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;       m1       m2       m3 </span></span>
<span><span class="co">#&gt; 295.2008 295.8445 296.3600</span></span></code></pre></div>
<p>We can retrieve the estimated parameters and the associated
<code>(1 - sig)</code> % confidence intervals by using the function
<code>summary_spm_fit</code> as follows</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/summary_spm_fit.html">summary_spm_fit</a></span><span class="op">(</span><span class="va">fit_msoa1</span>, sig <span class="op">=</span> <span class="fl">.05</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  optimization algorithm converged: yes </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     par   estimate        se               ci</span></span>
<span><span class="co">#&gt; 1    mu 75.9479977 0.8112112 [74.358; 77.538]</span></span>
<span><span class="co">#&gt; 2 sigsq 23.0875619 4.1812494 [14.892; 31.283]</span></span>
<span><span class="co">#&gt; 3   phi  0.8370629 0.2183420   [0.409; 1.265]</span></span></code></pre></div>
<p>Finally, we have almost everything we need to perform predictions at
the LSOA areas. The function <code>predict_spm</code> calculates the
predictions associated to the <code>spm_obj</code> (which contains the
results associated with a fitted model) into a <code>sf</code> object
given as an input for the argument <code>x</code>. We need to specify
whether we want to “aggregate” (i.e. average) the predicted surface over
the polygons associated with the <code>sf</code> data. The number of
points and the type of integration for prediction need to be set as
well. In this case we are specifying a finer grid (3500 points) because
the LSOA areas are smaller than the MSOA areas.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_lsoa</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predict_spm.html">predict_spm</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">liv_lsoa</span>, spm_obj <span class="op">=</span> <span class="va">fit_msoa1</span>, id_var <span class="op">=</span> <span class="st">"lsoa11cd"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: st_centroid assumes attributes are constant over geometries</span></span></code></pre></div>
<p>The resulting object is a list with entries <code>"mu_pred"</code>,
<code>"sig_pred"</code>, <code>"pred_grid"</code>,
<code>"pred_agg"</code>. The first two positions correspond to the mean
and covariance matrix at the predicted locations, respectively.
<code>"pred_grid"</code> can be seen as the predicted surface over the
study region, while <code>"pred_agg"</code> contains the (integrals)
averages of such surface within each LSOA area. The chunk of code below
plots the predicted life expectancy at the LSOA areas.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">pred_lsoa</span><span class="op">$</span><span class="va">pred_agg</span>,</span>
<span>       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill  <span class="op">=</span> <span class="va">mu_pred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fl">1</span>,</span>
<span>            lwd <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"H"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text  <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>          axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="fit-and-pred_files/figure-html/manip-pred-1-1.png" alt="Estimated LEB at LSOA in Liverpool." width="700"></p>
<p>Next, we plot the standard errors associated with the
predictions.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">pred_lsoa</span><span class="op">$</span><span class="va">pred_agg</span>,</span>
<span>       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill  <span class="op">=</span> <span class="va">se_pred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fl">1</span>,</span>
<span>            lwd <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"H"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text  <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>          axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="fit-and-pred_files/figure-html/se-ggplot2-1.png" alt="Standard errors of the estimates for LEB at LSOA in Liverpool." width="700"></p>
<div class="section level2">
<h2 class="unnumbered" id="reference">Reference<a class="anchor" aria-label="anchor" href="#reference"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-diggle2007model" class="csl-entry">
Diggle, PJ, and Paulo Justiniano Ribeiro. 2007. <span>“Model-Based
Geostatistics (Springer Series in Statistics).”</span> In, 51–56.
Springer.
</div>
<div id="ref-johnson2020dealing" class="csl-entry">
Johnson, Olatunji, Peter Diggle, and Emanuele Giorgi. 2020.
<span>“Dealing with Spatial Misalignment to Model the Relationship
Between Deprivation and Life Expectancy: <span>A</span> Model-Based
Geostatistical Approach.”</span> <em>International Journal of Health
Geographics</em> 19 (1): 1–13.
</div>
</div>
</div>

  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Powered by <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Lucas da Cunha Godoy. Provided without any warranty.</p>
</div>

    </footer>
</div>





  </body>
</html>
