<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>1. Converting sf objects to spm • smile</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Roboto-0.4.9/font.css" rel="stylesheet">
<link href="../deps/JetBrains_Mono-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Roboto_Slab-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="1. Converting sf objects to spm">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">smile</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.5</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fa-home"></span> HOME</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa fa-book"></span> Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes">
<li><a class="dropdown-item" href="../articles/sf-to-spm.html">1. Converting sf objects to spm</a></li>
    <li><a class="dropdown-item" href="../articles/fit-and-pred.html">2. Fitting models and making predictions</a></li>
    <li><a class="dropdown-item" href="../articles/sai.html">3. Areal Interpolation</a></li>
    <li><a class="dropdown-item" href="../articles/theory.html">4. Method</a></li>
    <li><a class="dropdown-item" href="../articles/sp-cov-functions.html">5. Spatial covariance functions</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html"><span class="fa fa-search fa-lg"></span> Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://lcgodoy.me" aria-label="Personal website"><span class="fa fa-globe"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/lcgodoy" aria-label="GitHub Profile"><span class="fa fa-github"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://www.linkedin.com/in/godoy-lucas/" aria-label="Linkedin Profile"><span class="fa fa-linkedin"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>1. Converting sf objects to spm</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/lcgodoy/smile/blob/main/vignettes/sf-to-spm.Rmd" class="external-link"><code>vignettes/sf-to-spm.Rmd</code></a></small>
      <div class="d-none name"><code>sf-to-spm.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lcgodoy.me/smile/">smile</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Linking to GEOS 3.10.2, GDAL 3.4.1, PROJ 8.2.1; sf_use_s2() is TRUE</span></span></code></pre></div>
<p>Spatial data often needs to be analyzed at different scales or
resolutions. This package helps you align disparate spatial data using
two approaches:</p>
<ul>
<li><p><strong>Model-based</strong>: This approach is based on the
assumption that areal data (e.g., variables measured at census tracts)
are composed by averages of a continuous underlying process <span class="citation">(Gelfand, Zhu, and Carlin 2001)</span>. In particular,
we assume this underlying process to be a Gaussian Process <span class="citation">Johnson, Diggle, and Giorgi (2020)</span>.</p></li>
<li><p><strong>Non-parametric spatial interpolation:</strong> This
simpler method estimates values at a new spatial support based on the
area of intersection between areal units. If you are interested in the
non-parametric approach, visit <a href="https://lcgodoy.me/smile/articles/sai.html">our vignette on the
topic</a>.</p></li>
</ul>
<p>This vignette focuses on the model-based approach for areal data
(like, for instance, census tract data). This method involves converting
<code>sf</code><span class="citation">(Pebesma 2018)</span> objects (a
common format for spatial data in R) to the spm format used by this
package. We’ll use the <code>ggplot2</code><span class="citation">(Wickham 2011)</span> package for visualization.</p>
<p>To demonstrate this conversion, we’ll use life expectancy at birth
(LEB) and the index of multiple deprivation (IMD) data for Liverpool
from <span class="citation">Johnson, Diggle, and Giorgi (2020)</span>.
This data is available at different spatial resolutions (MSOA and LSOA).
See Figure for a visualization of life expectancy at the MSOA level.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">liv_lsoa</span><span class="op">)</span> <span class="co"># loading the LSOA data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">liv_msoa</span><span class="op">)</span> <span class="co"># loading the MSOA data</span></span>
<span></span>
<span><span class="co">## workaround for compatibility with different PROJ versions</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">liv_msoa</span><span class="op">)</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">liv_msoa</span><span class="op">)</span><span class="op">$</span><span class="va">input</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">liv_lsoa</span><span class="op">)</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">liv_lsoa</span><span class="op">)</span><span class="op">$</span><span class="va">input</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">liv_msoa</span>,</span>
<span>       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">leb_est</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>            lwd   <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_b</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"H"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="sf-to-spm_files/figure-html/read-data-1.png" alt="LEB in Liverpool at the MSOA." width="700"><p class="caption">
LEB in Liverpool at the MSOA.
</p>
</div>
<!-- We consider, in a first moment, that this random variable is normally -->
<!-- distributed with a constant mean and a certain (spatial) covariance -->
<!-- matrix. Now, let $A_1$ and $A_2$ be two distinct MSOA's. Under the -->
<!--
before mentioned assumption that the observed random variable is driven -->
<!--
by an underlying Gaussian random field with isotropic covariance -->
<!--
function $C(\lVert x - y \rVert \, ; \, \theta)$, where $\lVert x - y -->
<!--
\rVert$ is the distance between two points in the coordinates $x$ and -->
<!--
$y$, respectively. Then, the covariance between the (averaged) variable -->
<!--
observed at $A_1$ and $A_2$ is define as \[ \Sigma_{12} = Cov(A_1, A_2) -->
<!--
= \frac{1}{\lvert A_1 \rvert \lvert A_2 \rvert} \int_{A_1} \int_{A_2} -->
<!--
C(\lVert x - y \rVert; \theta) \, dy \, dx.  \] In order to approximate -->
<!--
the continuous surface on which these covariances have to be computed, -->
<!--
we generate a fine grid over the whole study region (or a fine grid -->
<!--
within each MSOA) and approximate such covariance by numerical integration. -->
<p>To analyze the relationship between life expectancy (LEB) and
deprivation at the LSOA level, we need to estimate LEB at this higher
resolution. We assume LEB follows a continuous spatial pattern
represented by a Gaussian process.</p>
<p>Mathematically, the observed LEB in an areal resolution (e.g., an
MSOA) as averages of a continuous underlying process across that area.
If we knew the exact parameters of this process, we could calculate the
LEB for any location. However, these calculations involve complex
integrals that are difficult to solve analytically. For more details on
the theory behind this, see this <a href="https://lcgodoy.me/smile/articles/theory.html">vignette</a>.</p>
<p>The <code>sf_to_spm</code> function controls how the model-based
approach will approximate these integrals. It supports either numerical
or Monte Carlo integration. Here’s how different parameters of this
function change the integration method:</p>
<ul>
<li><p><code>type</code>: Controls the grid used for approximating the
integrals. Options include “regular”, “hexagonal” (both for numerical
integration), and “random” (for Monte Carlo integration).</p></li>
<li><p><code>npts</code>: Specifies the number of grid points used to
approximate the integral. This can be a single value or a vector with
different values for each area. More points generally improve accuracy
but increase computation time.</p></li>
<li>
<p><code>by_polygon</code>: Determines if the precision of the
approximation should vary by polygon size.</p>
<ul>
<li>
<code>TRUE</code>: All integrals are estimated with the same
precision.</li>
<li>
<code>FALSE</code>: A grid of points is generated over the entire
region, and points are assigned to the areas they fall within. This
results in more points and higher accuracy for larger polygons.</li>
</ul>
</li>
</ul>
<p>This approach allows us to estimate LEB at the LSOA level while
accounting for the underlying spatial structure of the data.</p>
<p>The code below converts the <code>liv_msoa</code> object (in
<code>sf</code> format) to an <code>spm</code> object. We generate a
grid of 1000 points across Liverpool and assign each point to its
corresponding area.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">msoa_spm</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="../reference/sf_to_spm.html">sf_to_spm</a></span><span class="op">(</span>sf_obj <span class="op">=</span> <span class="va">liv_msoa</span>, n_pts <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>              type <span class="op">=</span> <span class="st">"regular"</span>, by_polygon <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>              poly_ids <span class="op">=</span> <span class="st">"msoa11cd"</span>, var_ids <span class="op">=</span> <span class="st">"leb_est"</span><span class="op">)</span></span></code></pre></div>
<p>Here’s what the additional arguments of the <code>sf_to_spm</code>
function do:</p>
<ul>
<li><p><code>poly_ids</code>: Specifies the column in liv_msoa that
contains the unique identifier for each area (e.g., an area
ID).</p></li>
<li><p><code>var_ids</code>: Indicates the column containing the
“response variable” – the variable we want to model (e.g., life
expectancy).</p></li>
</ul>
<p>This conversion prepares the data for spatial analysis using the
<code>smile</code> package.</p>
For the sake of comparison, the Figure below displays the grids
associated with each of the possible combinations of the parameters
<code>type</code> and <code>by_polygon</code> when calling the
<code>sf_to_spm</code> function.
<div class="figure">
<img src="sf-to-spm_files/figure-html/sf-to-spm2-1.png" alt="Panel illustrating the grids generated for different approaches to approximate numerical integrals in the model-based approach." width="700"><p class="caption">
Panel illustrating the grids generated for different approaches to
approximate numerical integrals in the model-based approach.
</p>
</div>
<p>For details on fitting models and making predictions, see <a href="https://lcgodoy.me/smile/articles/fit-and-pred.html">this
vignette</a>.</p>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-gelfand2001change" class="csl-entry">
Gelfand, Alan E, Li Zhu, and Bradley P Carlin. 2001. <span>“On the
Change of Support Problem for Spatio-Temporal Data.”</span>
<em>Biostatistics</em> 2 (1): 31–45.
</div>
<div id="ref-johnson2020dealing" class="csl-entry">
Johnson, Olatunji, Peter Diggle, and Emanuele Giorgi. 2020.
<span>“Dealing with Spatial Misalignment to Model the Relationship
Between Deprivation and Life Expectancy: <span>A</span> Model-Based
Geostatistical Approach.”</span> <em>International Journal of Health
Geographics</em> 19 (1): 1–13.
</div>
<div id="ref-moraga2017geostatistical" class="csl-entry">
Moraga, Paula, Susanna M Cramb, Kerrie L Mengersen, and Marcello Pagano.
2017. <span>“A Geostatistical Model for Combined Analysis of Point-Level
and Area-Level Data Using INLA and SPDE.”</span> <em>Spatial
Statistics</em> 21: 27–41.
</div>
<div id="ref-pebesma2018simple" class="csl-entry">
Pebesma, Edzer. 2018. <span>“<span class="nocase">Simple Features for R:
Standardized Support for Spatial Vector Data</span>.”</span>
<em><span>The R Journal</span></em> 10 (1): 439–46. <a href="https://doi.org/10.32614/RJ-2018-009" class="external-link">https://doi.org/10.32614/RJ-2018-009</a>.
</div>
<div id="ref-wickham2011ggplot2" class="csl-entry">
Wickham, Hadley. 2011. <span>“Ggplot2.”</span> <em>Wiley
Interdisciplinary Reviews: Computational Statistics</em> 3 (2): 180–85.
</div>
<div id="ref-wilson2020pointless" class="csl-entry">
Wilson, Katie, and Jon Wakefield. 2020. <span>“Pointless Spatial
Modeling.”</span> <em>Biostatistics</em> 21 (2): e17–32.
</div>
</div>
</div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Powered by <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Lucas da Cunha Godoy. Provided without any warranty.</p>
</div>

    </footer>
</div>





  </body>
</html>
